// ==UserScript==
// @name         LGTV Logger Shortener
// @namespace    http://tampermonkey.net/
// @version      1
// @description  Create IP Logger links with custom URL and slugs input
// @author       kr0m4
// @match        https://iplogger.org/account/*
// @match        https://iplogger.org/account
// @match        https://iplogger.org/logger/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸš€ IP Logger Batch Creator LOADED v1!');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    const CONFIG = {
        domain: '2no.co',
    };

    // Create one link
    async function createLink(url, domain, slug) {
        console.log(`\nâ†’ Creating: ${slug}`);

        const btn = document.querySelector('[data-dialog="logger-create"]');
        if (!btn) {
            console.log('âŒ Create button not found');
            return false;
        }
        btn.click();
        await new Promise(r => setTimeout(r, 80));

        const urlInput = document.querySelector('input[name="destination"]');
        if (urlInput) {
            urlInput.value = url;
            urlInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        await new Promise(r => setTimeout(r, 30));

        const domainSelect = document.querySelector('.domain-select-current');
        if (domainSelect) {
            domainSelect.click();
            await new Promise(r => setTimeout(r, 30));
            const domainOption = document.querySelector(`.domain-select-item[data-domain="${domain}"]`);
            if (domainOption) {
                domainOption.click();
                await new Promise(r => setTimeout(r, 25));
            }
        }

        const slugInput = document.querySelector('input[name="manual"]');
        if (slugInput) {
            slugInput.value = slug;
            slugInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        await new Promise(r => setTimeout(r, 30));

        const submitBtn = document.querySelector('#logger-create button[type="submit"]');
        if (!submitBtn) {
            console.log('âŒ Submit button not found');
            return false;
        }
        submitBtn.click();
        console.log('âœ“ Submit clicked!');

        await new Promise(r => setTimeout(r, 50));

        console.log(`âœ… Link created: https://${domain}/${slug}`);

        return true;
    }

    // Main process
    async function run() {
        console.log('\nğŸš€ RUN() FUNCTION CALLED');

        const state = JSON.parse(sessionStorage.getItem('batch_state') || 'null');

        if (!state || !state.running) {
            console.log('â¸ï¸ Batch is not running. Click START to begin.');
            return;
        }

        const remainingSlugs = state.remainingSlugs || [];
        const totalSlugs = state.totalSlugs || remainingSlugs.length;
        const completed = totalSlugs - remainingSlugs.length;

        console.log(`\nğŸ“Š Current State:`);
        console.log(`   Completed: ${completed}/${totalSlugs}`);
        console.log(`   Remaining: ${remainingSlugs.length}`);
        console.log(`   Success: ${state.success} | Failed: ${state.fail}`);
        console.log(`   Next slug: ${remainingSlugs[0] || 'DONE'}`);

        if (remainingSlugs.length === 0) {
            console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
            console.log('â•‘  ğŸ‰ ALL LINKS CREATED!             â•‘');
            console.log(`â•‘  Success: ${state.success}                        â•‘`);
            console.log(`â•‘  Failed: ${state.fail}                         â•‘`);
            console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // Generate all links from original slugs
            const allLinks = state.originalSlugs.map(slug => `https://${CONFIG.domain}/${slug}`).join('\n');

            // Mark batch as complete but keep the data
            state.running = false;
            state.completed = true;
            sessionStorage.setItem('batch_state', JSON.stringify(state));

            navigator.clipboard.writeText(allLinks).then(() => {
                console.log('ğŸ“‹ All links copied to clipboard!');
                alert(`âœ… Batch Complete!\n\n${state.success} links created!\n\nAll ${state.originalSlugs.length} links have been copied to your clipboard!\n\nYou can copy them again using the COPY ALL LINKS button.`);
            }).catch(err => {
                console.log('âŒ Failed to copy to clipboard:', err);
                alert(`âœ… Batch Complete!\n\n${state.success} links created!\n\nLinks:\n${allLinks}\n\nYou can copy them again using the COPY ALL LINKS button.`);
            });

            updateControlPanel();
            return;
        }

        const slug = remainingSlugs[0];
        console.log(`\n[${completed + 1}/${totalSlugs}] ğŸ”— Creating: ${slug}`);

        const success = await createLink(state.targetUrl, CONFIG.domain, slug);

        console.log(`\nğŸ—‘ï¸ REMOVING slug "${slug}" from queue...`);
        remainingSlugs.shift();

        if (success) state.success++;
        else state.fail++;

        state.remainingSlugs = remainingSlugs;
        sessionStorage.setItem('batch_state', JSON.stringify(state));

        console.log(`âœ… State updated and saved!`);
        console.log(`   Removed: "${slug}"`);
        console.log(`   Remaining: ${remainingSlugs.length}`);
        console.log(`   Next: ${remainingSlugs[0] || 'DONE'}`);

        console.log('\nğŸ”„ Returning to account page...');

        setTimeout(() => {
            window.location.href = 'https://iplogger.org/account/';
        }, 500);
    }

    // Show input modal
    function showInputModal() {
        const modal = document.createElement('div');
        modal.id = 'batch-input-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999999;
            font-family: Arial, sans-serif;
        `;

        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            ">
                <h2 style="margin: 0 0 20px 0; color: #667eea; font-size: 24px;">
                    ğŸ”— LGTV PENETRATOR ğŸ‘ŒğŸ‘ˆ
                </h2>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        Target URL:
                    </label>
                    <input
                        type="text"
                        id="target-url-input"
                        placeholder="https://example.com"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            font-size: 14px;
                            box-sizing: border-box;
                        "
                    />
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        Slugs (one per line):
                    </label>
                    <textarea
                        id="slugs-input"
                        placeholder="slug1&#10;slug2&#10;slug3"
                        style="
                            width: 100%;
                            height: 200px;
                            padding: 12px;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: monospace;
                            resize: vertical;
                            box-sizing: border-box;
                        "
                    ></textarea>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                        Enter each slug on a new line
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="modal-cancel-btn" style="
                        flex: 1;
                        padding: 12px;
                        background: #6b7280;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Cancel</button>
                    <button id="modal-start-btn" style="
                        flex: 1;
                        padding: 12px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Start Batch</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        document.getElementById('modal-cancel-btn').addEventListener('click', () => {
            modal.remove();
        });

        document.getElementById('modal-start-btn').addEventListener('click', () => {
            const url = document.getElementById('target-url-input').value.trim();
            const slugsText = document.getElementById('slugs-input').value.trim();

            if (!url) {
                alert('Please enter a target URL');
                return;
            }

            if (!slugsText) {
                alert('Please enter at least one slug');
                return;
            }

            const slugs = slugsText.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (slugs.length === 0) {
                alert('Please enter at least one valid slug');
                return;
            }

            modal.remove();
            startBatch(url, slugs);
        });
    }

    // Start batch
    function startBatch(url, slugs) {
        const state = {
            running: true,
            targetUrl: url,
            remainingSlugs: [...slugs],
            originalSlugs: [...slugs], // Store original slugs for copying
            totalSlugs: slugs.length,
            success: 0,
            fail: 0
        };
        sessionStorage.setItem('batch_state', JSON.stringify(state));
        console.log('â–¶ï¸ Batch STARTED!');
        console.log(`   Target URL: ${url}`);
        console.log(`   Total slugs: ${slugs.length}`);
        updateControlPanel();
        setTimeout(() => run(), 50);
    }

    // Stop batch
    function stopBatch() {
        const state = JSON.parse(sessionStorage.getItem('batch_state') || 'null');

        // If there are slugs, offer to copy the links before stopping
        if (state && state.originalSlugs && state.originalSlugs.length > 0) {
            const copy = confirm(`You have ${state.originalSlugs.length} slugs.\n\nDo you want to copy all the shortened links before stopping?`);
            if (copy) {
                copyAllLinks();
            }
        }

        sessionStorage.removeItem('batch_state');
        console.log('â¸ï¸ Batch STOPPED!');
        updateControlPanel();
    }

    // Reset batch
    function resetBatch() {
        sessionStorage.removeItem('batch_state');
        console.log('ğŸ”„ Batch RESET!');
        location.reload();
    }

    // Copy all links function
    function copyAllLinks() {
        console.log('ğŸ–±ï¸ Copy All Links button clicked!');

        const state = JSON.parse(sessionStorage.getItem('batch_state') || '{}');

        console.log('Current state:', state);
        console.log('Original slugs:', state.originalSlugs);

        if (!state.originalSlugs || state.originalSlugs.length === 0) {
            alert('âŒ No slugs found! Start a batch first.');
            console.log('âŒ No slugs found in state');
            return;
        }

        // Generate all links from the original slugs
        const allLinks = state.originalSlugs.map(slug => `https://${CONFIG.domain}/${slug}`).join('\n');

        console.log(`ğŸ“‹ Attempting to copy ${state.originalSlugs.length} links...`);

        navigator.clipboard.writeText(allLinks).then(() => {
            console.log('âœ… Links copied successfully!');
            alert(`âœ… Copied ${state.originalSlugs.length} links to clipboard!\n\n${allLinks}`);
        }).catch(err => {
            console.log('âŒ Failed to copy to clipboard:', err);
            alert(`Links:\n\n${allLinks}`);
        });
    }

    // Update control panel
    function updateControlPanel() {
        const panel = document.getElementById('batch-control-panel');
        if (!panel) {
            console.log('âš ï¸ Panel not found, skipping update');
            return;
        }

        const state = JSON.parse(sessionStorage.getItem('batch_state') || '{}');

        // Check if we have original slugs (means batch was started)
        const linksCount = (state.originalSlugs && Array.isArray(state.originalSlugs)) ? state.originalSlugs.length : 0;
        const hasLinks = linksCount > 0;

        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ”„ UPDATING CONTROL PANEL');
        console.log(`Running: ${state.running}`);
        console.log(`Links Count: ${linksCount}`);
        console.log(`Has Links: ${hasLinks}`);
        console.log(`Original Slugs:`, state.originalSlugs);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        if (state.running) {
            const remaining = state.remainingSlugs || [];
            const total = state.totalSlugs || 0;
            const completed = total - remaining.length;

            panel.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ğŸ”— LGTV PENETRATOR ğŸ‘ŒğŸ‘ˆ
                </div>
                <div style="margin-bottom: 15px; font-size: 14px; line-height: 1.6;">
                    <strong>Progress:</strong> ${completed}/${total}<br>
                    <strong>Success:</strong> <span style="color: #10b981;">${state.success}</span><br>
                    <strong>Failed:</strong> <span style="color: #ef4444;">${state.fail}</span><br>
                    <strong>Total Links:</strong> ${linksCount}<br>
                    <strong>Next:</strong> ${remaining[0] || 'Done!'}
                </div>
                <button id="copyAllBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 8px;
                    transition: all 0.3s ease;
                ">ğŸ“‹ COPY ALL LINKS (${linksCount})</button>
                <button id="stopBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 8px;
                ">â¸ï¸ STOP</button>
                <button id="resetBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                ">ğŸ”„ RESET</button>
            `;

            document.getElementById('copyAllBtn').addEventListener('click', copyAllLinks);
            document.getElementById('stopBtn').addEventListener('click', stopBatch);
            document.getElementById('resetBtn').addEventListener('click', resetBatch);
        } else if (state.completed) {
            // Batch is complete - show completion status with copy button
            panel.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    âœ… Batch Complete!
                </div>
                <div style="margin-bottom: 15px; font-size: 14px; line-height: 1.6;">
                    <strong>Total Created:</strong> ${linksCount}<br>
                    <strong>Success:</strong> <span style="color: #10b981;">${state.success || 0}</span><br>
                    <strong>Failed:</strong> <span style="color: #ef4444;">${state.fail || 0}</span>
                </div>
                <button id="copyAllBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 8px;
                    transition: all 0.3s ease;
                ">ğŸ“‹ COPY ALL LINKS (${linksCount})</button>
                <button id="resetBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                ">ğŸ”„ START NEW BATCH</button>
            `;

            document.getElementById('copyAllBtn').addEventListener('click', copyAllLinks);
            document.getElementById('resetBtn').addEventListener('click', resetBatch);
        } else {
            panel.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ğŸ”— LGTV PENETRATOR ğŸ‘ŒğŸ‘ˆ
                </div>
                <div style="margin-bottom: 15px; font-size: 14px; color: #6b7280;">
                    Ready to create batch links
                </div>
                <button id="startBtn" style="
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    margin-bottom: 10px;
                ">â–¶ï¸ START BATCH</button>
                <button id="copyAllBtn" style="
                    width: 100%;
                    padding: 12px;
                    background: ${hasLinks ? '#10b981' : '#d1d5db'};
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: ${hasLinks ? 'pointer' : 'not-allowed'};
                    opacity: ${hasLinks ? '1' : '0.6'};
                    transition: all 0.3s ease;
                ">ğŸ“‹ COPY ALL LINKS${hasLinks ? ` (${linksCount})` : ' (0)'}</button>
            `;

            document.getElementById('startBtn').addEventListener('click', showInputModal);

            const copyBtn = document.getElementById('copyAllBtn');
            copyBtn.addEventListener('click', (e) => {
                if (!hasLinks) {
                    alert('âš ï¸ No links available! Start a batch first.');
                    return;
                }
                copyAllLinks();
            });
        }
    }

    // Create control panel
    function createControlPanel() {
        const panel = document.createElement('div');
        panel.id = 'batch-control-panel';
        panel.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 999999;
            min-width: 280px;
            font-family: Arial, sans-serif;
        `;

        document.body.appendChild(panel);
        updateControlPanel();

        console.log('âœ… Control panel added!');
    }

    // Check if we should continue batch
    function checkAndContinueBatch() {
        console.log('\nğŸ” Checking if batch should continue...');

        const state = JSON.parse(sessionStorage.getItem('batch_state') || 'null');

        if (!state) {
            console.log('   No state found');
            return;
        }

        console.log(`   State found: running=${state.running}, completed=${state.completed}`);
        console.log(`   Remaining slugs: ${state.remainingSlugs?.length || 0}`);
        console.log(`   Original slugs: ${state.originalSlugs?.length || 0}`);

        // If batch is completed, just update the panel to show completion state
        if (state.completed) {
            console.log('   âœ… Batch is complete! Showing completion panel.');
            updateControlPanel();
            return;
        }

        // If batch is running and has remaining slugs, continue
        if (state && state.running && state.remainingSlugs && state.remainingSlugs.length > 0) {
            console.log('   âœ… Batch should continue!');
            console.log(`   Next slug: ${state.remainingSlugs[0]}`);
            console.log('   Starting in 1.5 seconds...\n');

            // Update panel to show current progress
            updateControlPanel();

            setTimeout(() => {
                console.log('â° Time passed, calling run()...');
                run();
            }, 1500);
        } else {
            console.log('   â¸ï¸ Batch not running or no slugs left');
            updateControlPanel();
        }
    }

    // Initialize
    console.log('\nğŸ Initializing script...');
    console.log(`   Current URL: ${window.location.href}`);
    console.log(`   Pathname: ${window.location.pathname}`);

    setTimeout(() => {
        if (window.location.pathname.startsWith('/logger/')) {
            console.log('ğŸ“ On logger detail page, returning to account...');
            setTimeout(() => {
                window.location.href = 'https://iplogger.org/account/';
            }, 50);
            return;
        }

        if (window.location.pathname.startsWith('/account')) {
            console.log('ğŸ“ On account page');
            createControlPanel();
            checkAndContinueBatch();
        }
    }, 50);

})();